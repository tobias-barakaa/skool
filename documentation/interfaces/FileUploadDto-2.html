<!doctype html>
<html class="no-js" lang="">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <title>skool documentation</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <link rel="icon" type="image/x-icon" href="../images/favicon.ico">
	   <link rel="stylesheet" href="../styles/style.css">
        <link rel="stylesheet" href="../styles/dark.css">
    </head>
    <body>
          <script>
               // Blocking script to avoid flickering dark mode
               // Dark mode toggle button
               var useDark = window.matchMedia('(prefers-color-scheme: dark)');
               var darkModeState = useDark.matches;
               var $darkModeToggleSwitchers = document.querySelectorAll('.dark-mode-switch input');
               var $darkModeToggles = document.querySelectorAll('.dark-mode-switch');
               var darkModeStateLocal = localStorage.getItem('compodoc_darkmode-state');

               function checkToggle(check) {
                    for (var i = 0; i < $darkModeToggleSwitchers.length; i++) {
                         $darkModeToggleSwitchers[i].checked = check;
                    }
               }

               function toggleDarkMode(state) {
                    if (window.localStorage) {
                         localStorage.setItem('compodoc_darkmode-state', state);
                    }

                    checkToggle(state);

                    const hasClass = document.body.classList.contains('dark');

                    if (state) {
                         for (var i = 0; i < $darkModeToggles.length; i++) {
                              $darkModeToggles[i].classList.add('dark');
                         }
                         if (!hasClass) {
                              document.body.classList.add('dark');
                         }
                    } else {
                         for (var i = 0; i < $darkModeToggles.length; i++) {
                              $darkModeToggles[i].classList.remove('dark');
                         }
                         if (hasClass) {
                              document.body.classList.remove('dark');
                         }
                    }
               }

               useDark.addEventListener('change', function (evt) {
                    toggleDarkMode(evt.matches);
               });
               if (darkModeStateLocal) {
                    darkModeState = darkModeStateLocal === 'true';
               }
               toggleDarkMode(darkModeState);
          </script>

        <div class="navbar navbar-default navbar-fixed-top d-md-none p-0">
               <div class="d-flex">
                    <a href="../" class="navbar-brand">skool documentation</a>
                    <button type="button" class="btn btn-default btn-menu ion-ios-menu" id="btn-menu"></button>
               </div>
        </div>

        <div class="xs-menu menu" id="mobile-menu">
                <div id="book-search-input" role="search"><input type="text" placeholder="Type to search"></div>            <compodoc-menu></compodoc-menu>
        </div>

        <div class="container-fluid main">
           <div class="row main">
               <div class="d-none d-md-block menu">
                   <compodoc-menu mode="normal"></compodoc-menu>
               </div>
               <!-- START CONTENT -->
               <div class="content interface">
                   <div class="content-data">













<ol class="breadcrumb">
  <li class="breadcrumb-item">Interfaces</li>
  <li class="breadcrumb-item"
  >
  FileUploadDto</li>
</ol>

<ul class="nav nav-tabs" role="tablist">
        <li class="nav-item">
            <a href="#info" 
                class="nav-link"
                class="nav-link active"
                role="tab" id="info-tab" data-bs-toggle="tab" data-link="info">Info</a>
        </li>
        <li class="nav-item">
            <a href="#source" 
                class="nav-link"
                
                role="tab" id="source-tab" data-bs-toggle="tab" data-link="source">Source</a>
        </li>
</ul>

<div class="tab-content">
    <div class="tab-pane fade active in" id="info">
        <p class="comment">
            <h3>File</h3>
        </p>
        <p class="comment">
            <code>src/modules/storage/services/backblaze.service.ts</code>
        </p>




        <section data-compodoc="block-index">
            <h3 id="index">Index</h3>
            <table class="table table-sm table-bordered index-table">
                <tbody>
                    <tr>
                        <td class="col-md-4">
                            <h6><b>Properties</b></h6>
                        </td>
                    </tr>
                    <tr>
                        <td class="col-md-4">
                            <ul class="index-list">
                                <li>
                                        <a href="#entityId" 
>
                                            entityId
                                        </a>
                                </li>
                                <li>
                                        <a href="#entityType" 
>
                                            entityType
                                        </a>
                                </li>
                                <li>
                                            <span class="modifier">Optional</span>
                                        <a href="#tenantId" 
>
                                            tenantId
                                        </a>
                                </li>
                                <li>
                                            <span class="modifier">Optional</span>
                                        <a href="#userId" 
>
                                            userId
                                        </a>
                                </li>
                            </ul>
                        </td>
                    </tr>
                </tbody>
            </table>
        </section>



            <section data-compodoc="block-properties">
                <h3 id="inputs">Properties</h3>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="entityId"></a>
                                        <span class="name "><b>entityId</b>
                                            <a href="#entityId">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>entityId:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="entityType"></a>
                                        <span class="name "><b>entityType</b>
                                            <a href="#entityType">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>entityType:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                                        </td>
                                    </tr>





                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="tenantId"></a>
                                        <span class="name "><b>tenantId</b>
                                            <a href="#tenantId">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>tenantId:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                                        </td>
                                    </tr>

                                    <tr>
                                        <td class="col-md-4">
                                            <i>Optional</i>
                                        </td>
                                    </tr>




                        </tbody>
                    </table>
                    <table class="table table-sm table-bordered">
                        <tbody>
                                <tr>
                                    <td class="col-md-4">
                                        <a name="userId"></a>
                                        <span class="name "><b>userId</b>
                                            <a href="#userId">
                                                <span class="icon ion-ios-link"></span>
                                            </a>
                                        </span>
                                    </td>
                                </tr>
                                <tr>
                                    <td class="col-md-4">
                                        <code>userId:         <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>
</code>
                                    </td>
                                </tr>


                                    <tr>
                                        <td class="col-md-4">
                                            <i>Type : </i>        <code><a href="https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/string" target="_blank" >string</a></code>

                                        </td>
                                    </tr>

                                    <tr>
                                        <td class="col-md-4">
                                            <i>Optional</i>
                                        </td>
                                    </tr>




                        </tbody>
                    </table>
            </section>
    </div>


    <div class="tab-pane fade  tab-source-code" id="source">
        <pre class="line-numbers compodoc-sourcecode"><code class="language-typescript">import {
  Injectable,
  BadRequestException,
  InternalServerErrorException,
  Inject,
} from &#x27;@nestjs/common&#x27;;
import { ConfigService, ConfigType } from &#x27;@nestjs/config&#x27;;
import { 
  S3Client,  
  HeadBucketCommand, 
  DeleteObjectCommand,
  ListObjectsV2Command,
  GetObjectCommand
} from &#x27;@aws-sdk/client-s3&#x27;;
import { getSignedUrl } from &#x27;@aws-sdk/s3-request-presigner&#x27;;
import { Upload } from &#x27;@aws-sdk/lib-storage&#x27;;
import { v4 as uuidv4 } from &#x27;uuid&#x27;;
import backblazeConfig from &#x27;src/config/backblaze.config&#x27;;

interface FileUploadDto {
  tenantId?: string;
  entityType: string;
  entityId: string;
  userId?: string;
}

interface FileUploadResult {
  id: string;
  fileName: string;
  originalName: string;
  mimeType: string;
  size: number;
  url: string;
  path: string;
  tenantId: string;
  entityType: string;
  entityId: string;
  userId?: string;
  uploadedAt: Date;
}

@Injectable()
export class BackblazeService {
  private readonly s3Clients: S3Client[];
  private readonly bucketName: string;
  private readonly maxRetries &#x3D; 3;
  private readonly retryDelay &#x3D; 1000;
  private readonly endpoints &#x3D; [
    &#x27;https://s3.us-east-005.backblazeb2.com&#x27;,
    &#x27;https://s3.us-east-005.backblazeb2.com&#x27;,
    &#x27;https://s3.us-east-005.backblazeb2.com&#x27;,
  ];

  constructor(
    private readonly configService: ConfigService,
    @Inject(backblazeConfig.KEY)
    private readonly config: ConfigType&lt;typeof backblazeConfig&gt;,
  ) {
    this.bucketName &#x3D;
      this.config.bucketName ??
      (() &#x3D;&gt; {
        throw new Error(&#x27;Bucket name is not defined in the configuration&#x27;);
      })();

    this.s3Clients &#x3D; this.endpoints.map(
      (endpoint) &#x3D;&gt;
        new S3Client({
          endpoint,
          region: this.config.region,
          credentials: {
            accessKeyId:
              this.config.keyId ??
              (() &#x3D;&gt; {
                throw new Error(&#x27;Key ID is not defined in the configuration&#x27;);
              })(),
            secretAccessKey:
              this.config.applicationKey ??
              (() &#x3D;&gt; {
                throw new Error(
                  &#x27;Application key is not defined in the configuration&#x27;,
                );
              })(),
          },
          forcePathStyle: true,
          requestHandler: {
            requestTimeout: 15000,
            connectionTimeout: 5000,
          },
          maxAttempts: 1, 
        }),
    );
  }

  async uploadFile(
    file: Express.Multer.File,
    dto: FileUploadDto,
  ): Promise&lt;FileUploadResult&gt; {
    if (!file) {
      throw new BadRequestException(&#x27;No file provided&#x27;);
    }

    console.log(
      &#x60;Uploading file: ${file.originalname} (${file.size} bytes)&#x60;,
    );

    const allowedMimeTypes &#x3D; [
      &#x27;image/jpeg&#x27;,
      &#x27;image/png&#x27;,
      &#x27;image/gif&#x27;,
      &#x27;image/webp&#x27;,
      &#x27;application/pdf&#x27;,
      &#x27;text/plain&#x27;,
      &#x27;application/msword&#x27;,
      &#x27;application/vnd.openxmlformats-officedocument.wordprocessingml.document&#x27;,
    ];

    if (!allowedMimeTypes.includes(file.mimetype)) {
      throw new BadRequestException(&#x60;Unsupported file type: ${file.mimetype}&#x60;);
    }

    const fileName &#x3D; this.generateUniqueFileName(file.originalname);
    const filePath &#x3D; this.generateFilePath(dto, fileName);

    return this.uploadWithRetry(file, dto, fileName, filePath);
  }

  private async uploadWithRetry(
    file: Express.Multer.File,
    dto: FileUploadDto,
    fileName: string,
    filePath: string,
    attempt &#x3D; 1,
  ): Promise&lt;FileUploadResult&gt; {
    const MAX_BYTES &#x3D; 10 * 1024 * 1024; 
    if (file.size &gt; MAX_BYTES) {
      throw new BadRequestException(
        &#x60;File too large. Maximum allowed size is 10 MB.&#x60;,
      );
    }

    for (
      let endpointIndex &#x3D; 0;
      endpointIndex &lt; this.s3Clients.length;
      endpointIndex++
    ) {
      const s3Client &#x3D; this.s3Clients[endpointIndex];
      const endpoint &#x3D; this.endpoints[endpointIndex];

      try {
        console.log(
          &#x60;Upload attempt ${attempt}/${this.maxRetries + 1} for file: ${fileName} using endpoint: ${endpoint}&#x60;,
        );

        const upload &#x3D; new Upload({
          client: s3Client,
          params: {
            Bucket: this.bucketName,
            Key: filePath,
            Body: file.buffer,
            ContentType: file.mimetype,
            Metadata: {
              tenantId: dto.tenantId || &#x27;&#x27;,
              entityType: dto.entityType,
              entityId: dto.entityId,
              userId: dto.userId || &#x27;&#x27;,
              originalName: file.originalname,
              uploadedAt: new Date().toISOString(),
            },
          },
        });

        upload.on(&#x27;httpUploadProgress&#x27;, (progress: any) &#x3D;&gt; {
          console.log(&#x60;Upload progress: ${JSON.stringify(progress)}&#x60;);
        });

        const abortController &#x3D; new AbortController();
        const timeoutId &#x3D; setTimeout(() &#x3D;&gt; {
          abortController.abort();
        }, 15000);

        upload.on(&#x27;httpUploadProgress&#x27;, () &#x3D;&gt; {
          clearTimeout(timeoutId);
        });

        const result &#x3D; await upload.done();
        clearTimeout(timeoutId);

        console.log(
          &#x60;Successfully uploaded file: ${fileName} to ${result.Location} via ${endpoint}&#x60;,
        );

        return {
          id: uuidv4(),
          fileName,
          originalName: file.originalname,
          mimeType: file.mimetype,
          size: file.size,
          url: result.Location || &#x60;${endpoint}/${this.bucketName}/${filePath}&#x60;,
          path: filePath,
          tenantId: dto.tenantId || &#x27;&#x27;,
          entityType: dto.entityType,
          entityId: dto.entityId,
          userId: dto.userId,
          uploadedAt: new Date(),
        };
      } catch (err) {
        console.error(
          &#x60;S3 Upload Error (attempt ${attempt}, endpoint ${endpoint}):&#x60;,
          {
            error: err.message || &#x27;Unknown error&#x27;,
            name: err.name,
            code: err.code,
            statusCode: err.$metadata?.httpStatusCode,
            retryable: err.$retryable,
          },
        );

        if (
          endpointIndex &#x3D;&#x3D;&#x3D; this.s3Clients.length - 1 &amp;&amp;
          attempt &lt;&#x3D; this.maxRetries
        ) {
          const delay &#x3D; this.calculateRetryDelay(attempt);
          console.log(
            &#x60;All endpoints failed for attempt ${attempt}. Retrying in ${delay}ms...&#x60;,
          );
          await this.sleep(delay);
          return this.uploadWithRetry(
            file,
            dto,
            fileName,
            filePath,
            attempt + 1,
          );
        }

        if (endpointIndex &lt; this.s3Clients.length - 1) {
          console.log(&#x60;Trying next endpoint...&#x60;);
          continue;
        }
      }
    }

    throw new InternalServerErrorException(
      &#x60;Failed to upload after ${attempt} attempts across all endpoints&#x60;,
    );
  }

  private calculateRetryDelay(attempt: number): number {
    const baseDelay &#x3D; this.retryDelay * Math.pow(2, attempt - 1);
    const jitter &#x3D; Math.random() * 1000;
    return Math.min(baseDelay + jitter, 10000);
  }

  private sleep(ms: number): Promise&lt;void&gt; {
    return new Promise((resolve) &#x3D;&gt; setTimeout(resolve, ms));
  }

  private generateFilePath(dto: FileUploadDto, fileName: string): string {
    return &#x60;tenants/${dto.tenantId}/${dto.entityType}/${dto.entityId}/files/${fileName}&#x60;;
  }

  private generateUniqueFileName(originalName: string): string {
    const timestamp &#x3D; Date.now();
    const uuid &#x3D; uuidv4().slice(0, 8);
    const dotIndex &#x3D; originalName.lastIndexOf(&#x27;.&#x27;);
    const name &#x3D;
      dotIndex !&#x3D;&#x3D; -1 ? originalName.substring(0, dotIndex) : originalName;
    const ext &#x3D; dotIndex !&#x3D;&#x3D; -1 ? originalName.substring(dotIndex + 1) : &#x27;bin&#x27;;
    return &#x60;${timestamp}-${uuid}-${name}.${ext}&#x60;;
  }

  async testConnection(): Promise&lt;
    { endpoint: string; status: boolean; error?: string }[]
  &gt; {
    const results: { endpoint: string; status: boolean; error?: string }[] &#x3D; [];

    for (let i &#x3D; 0; i &lt; this.s3Clients.length; i++) {
      const s3Client &#x3D; this.s3Clients[i];
      const endpoint &#x3D; this.endpoints[i];

      try {
        const command &#x3D; new HeadBucketCommand({ Bucket: this.bucketName });
        
        await Promise.race([
          s3Client.send(command),
          new Promise((_, reject) &#x3D;&gt;
            setTimeout(() &#x3D;&gt; reject(new Error(&#x27;Timeout&#x27;)), 5000),
          ),
        ]);
        
        results.push({ endpoint, status: true });
      } catch (error) {
        results.push({ 
          endpoint, 
          status: false, 
          error: error.message || error.name 
        });
      }
    }

    return results;
  }

  async getBestEndpoint(): Promise&lt;string | null&gt; {
    const results &#x3D; await this.testConnection();
    const healthy &#x3D; results.find((r) &#x3D;&gt; r.status);
    return healthy?.endpoint || null;
  }

  async uploadMultipleFiles(
    files: Express.Multer.File[],
    dto: FileUploadDto,
  ): Promise&lt;FileUploadResult[]&gt; {
    const concurrencyLimit &#x3D; 3;
    const results: FileUploadResult[] &#x3D; [];
    
    for (let i &#x3D; 0; i &lt; files.length; i +&#x3D; concurrencyLimit) {
      const batch &#x3D; files.slice(i, i + concurrencyLimit);
      const batchResults &#x3D; await Promise.all(
        batch.map((file) &#x3D;&gt; this.uploadFile(file, dto))
      );
      results.push(...batchResults);
    }
    
    return results;
  }

  async deleteFile(filePath: string): Promise&lt;void&gt; {
    const command &#x3D; new DeleteObjectCommand({
      Bucket: this.bucketName,
      Key: filePath,
    });

    try {
      await this.s3Clients[0].send(command);
    } catch (err) {
      throw new InternalServerErrorException(
        &#x60;Failed to delete file: ${err.message}&#x60;,
      );
    }
  }

  async getSignedUrl(filePath: string, expiresIn &#x3D; 3600): Promise&lt;string&gt; {
    try {
      const command &#x3D; new GetObjectCommand({
        Bucket: this.bucketName,
        Key: filePath,
      });

      return await getSignedUrl(this.s3Clients[0], command, {
        expiresIn,
      });
    } catch (err) {
      throw new InternalServerErrorException(
        &#x60;Failed to create signed URL: ${err.message}&#x60;,
      );
    }
  }

  async listEntityFiles(
    tenantId: string,
    entityType: string,
    entityId: string,
  ): Promise&lt;any[]&gt; {
    try {
      const prefix &#x3D; &#x60;tenants/${tenantId}/${entityType}/${entityId}/files/&#x60;;
      const command &#x3D; new ListObjectsV2Command({
        Bucket: this.bucketName,
        Prefix: prefix,
      });

      const result &#x3D; await this.s3Clients[0].send(command);
      return result.Contents || [];
    } catch (err) {
      throw new InternalServerErrorException(
        &#x60;Failed to list files: ${err.message}&#x60;,
      );
    }
  }
}</code></pre>
    </div>
</div>








                   </div><div class="search-results">
    <div class="has-results">
        <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
        <ul class="search-results-list"></ul>
    </div>
    <div class="no-results">
        <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
    </div>
</div>
</div>
               <!-- END CONTENT -->
           </div>
       </div>

          <label class="dark-mode-switch">
               <input type="checkbox">
               <span class="slider">
                    <svg class="slider-icon" viewBox="0 0 24 24" fill="none" height="20" stroke="#000" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" width="20" xmlns="http://www.w3.org/2000/svg">
                    <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"></path>
                    </svg>
               </span>
          </label>

       <script>
            var COMPODOC_CURRENT_PAGE_DEPTH = 1;
            var COMPODOC_CURRENT_PAGE_CONTEXT = 'interface';
            var COMPODOC_CURRENT_PAGE_URL = 'FileUploadDto-2.html';
            var MAX_SEARCH_RESULTS = 15;
       </script>

       <script>
               $darkModeToggleSwitchers = document.querySelectorAll('.dark-mode-switch input');
               checkToggle(darkModeState);
               if ($darkModeToggleSwitchers.length > 0) {
                    for (var i = 0; i < $darkModeToggleSwitchers.length; i++) {
                         $darkModeToggleSwitchers[i].addEventListener('change', function (event) {
                              darkModeState = !darkModeState;
                              toggleDarkMode(darkModeState);
                         });
                    }
               }
          </script>

       <script src="../js/libs/custom-elements.min.js"></script>
       <script src="../js/libs/lit-html.js"></script>

       <script src="../js/menu-wc.js" defer></script>
       <script nomodule src="../js/menu-wc_es5.js" defer></script>

       <script src="../js/libs/bootstrap-native.js"></script>

       <script src="../js/libs/es6-shim.min.js"></script>
       <script src="../js/libs/EventDispatcher.js"></script>
       <script src="../js/libs/promise.min.js"></script>

       <script src="../js/compodoc.js"></script>

       <script src="../js/tabs.js"></script>
       <script src="../js/menu.js"></script>
       <script src="../js/libs/clipboard.min.js"></script>
       <script src="../js/libs/prism.js"></script>
       <script src="../js/sourceCode.js"></script>
          <script src="../js/search/search.js"></script>
          <script src="../js/search/lunr.min.js"></script>
          <script src="../js/search/search-lunr.js"></script>
          <script src="../js/search/search_index.js"></script>
       <script src="../js/lazy-load-graphs.js"></script>


    </body>
</html>
